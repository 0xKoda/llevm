<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLEVM - EVM Chat</title>
    <link rel="icon" type="image/png" href="bit.jpg">
    <style>

        @font-face {
            font-family: 'Monaspace Argon';
            src: url('/fonts/MonaspaceArgon-Regular.woff') format('woff');  
            font-weight: normal;
            font-style: normal;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            color: #F8F8F2;
            background-color: #282A36;
            font-family: 'Monaspace Argon', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100%;
            border: 1px solid #44475A;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            width: 60%;
            min-width: 200px;
            border-right: 1px solid #44475A;
        }

        .search-container {
            display: flex;
            padding: 10px;
            background-color: #44475A;
            border-bottom: 1px solid #6272A4;
        }

        #contract-address {
            flex-grow: 1;
            margin-right: 10px;
            background-color: #282A36;
            color: #F8F8F2;
            border: 1px solid #6272A4;
            padding: 5px;
            font-family: 'Monaspace Argon', monospace;
        }

        #search-btn {
            background-color: #44475A;
            color: #F8F8F2;
            border: 1px solid #6272A4;
            cursor: pointer;
            font-family: 'Monaspace Argon', monospace;
            padding: 5px 10px;
            transition: background-color 0.3s;
        }

        #search-btn:hover {
            background-color: #6272A4;
        }

        .tab-bar {
            display: flex;
            background-color: #44475A;
            border-bottom: 1px solid #6272A4;
        }

        .tab {
            padding: 5px 10px;
            cursor: pointer;
            border-right: 1px solid #6272A4;
            transition: background-color 0.3s;
        }

        .tab:hover {
            background-color: #6272A4;
        }

        .tab.active {
            background-color: #282A36;
            color: #FF79C6;
        }

        #bytecode-display,
        #decompiled-display,
        #opcodes-display,
        #yul-display,
        #instructions-display {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #282A36;
            color: #F8F8F2;
            font-family: 'Monaspace Argon', monospace;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #instructions-display {
            white-space: normal;
        }

        #instructions-display h2 {
            color: #FF79C6;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        #instructions-display ol {
            padding-left: 20px;
            margin-top: 0;
            margin-bottom: 10px;
        }

        #instructions-display li {
            margin-bottom: 5px;
        }

        #instructions-display p {
            margin-top: 0;
            margin-bottom: 10px;
        }

        #instructions-display br {
            display: none;
        }

        /* Remove any pre-existing styles that might affect spacing */
        #instructions-display pre,
        #instructions-display code {
            white-space: normal;
            margin: 0;
            padding: 0;
        }

        /* Theme-specific styles */
        .one-dark #instructions-display {
            background-color: #282C34;
            color: #ABB2BF;
        }

        .one-dark #instructions-display h2 {
            color: #C678DD;
        }

        .catppuccin-mocha #instructions-display {
            background-color: #1e1e2e;
            color: #cdd6f4;
        }

        .catppuccin-mocha #instructions-display h2 {
            color: #cba6f7;
        }

        .right-panel {
            width: 40%;
            min-width: 200px;
            display: flex;
            flex-direction: column;
        }

        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #282A36;
        }

        #chat-input {
            border-top: 1px solid #44475A;
            padding: 10px;
            display: flex;
            background-color: #44475A;
        }

        #chat-input input {
            flex-grow: 1;
            margin-right: 10px;
            background-color: #282A36;
            color: #F8F8F2;
            border: 1px solid #6272A4;
            padding: 5px;
            font-family: 'Monaspace Argon', monospace;
        }

        .resizer-x {
            width: 4px;
            background: #44475A;
            cursor: col-resize;
        }

        #send-chat {
            background-color: #44475A;
            color: #F8F8F2;
            border: 1px solid #6272A4;
            cursor: pointer;
            font-family: 'Monaspace Argon', monospace;
            padding: 5px 10px;
            transition: background-color 0.3s;
        }

        #send-chat:hover {
            background-color: #6272A4;
        }

        .chat-message {
            padding: 5px;
            margin: 5px 0;
            border-radius: 3px;
        }

        .chat-message.user {
            background-color: #44475A;
            border-left: 3px solid #BD93F9;
        }

        .chat-message.assistant {
            background-color: #383A59;
            border-left: 3px solid #50FA7B;
        }

        .chat-message.error {
            background-color: #44475A;
            border-left: 3px solid #FF5555;
            color: #FF5555;
        }

        /* Custom syntax highlighting theme */
        .hljs {
            display: block;
            overflow-x: auto;
            padding: 0.5em;
            background: #282A36;
            color: #F8F8F2;
        }

        .hljs-keyword,
        .hljs-selector-tag,
        .hljs-literal,
        .hljs-section,
        .hljs-link {
            color: #FF79C6;
        }

        .hljs-function .hljs-keyword {
            color: #8BE9FD;
        }

        .hljs-subst {
            color: #F8F8F2;
        }

        .hljs-string,
        .hljs-title,
        .hljs-name,
        .hljs-type,
        .hljs-attribute,
        .hljs-symbol,
        .hljs-bullet,
        .hljs-addition,
        .hljs-variable,
        .hljs-template-tag,
        .hljs-template-variable {
            color: #F1FA8C;
        }

        .hljs-comment,
        .hljs-quote,
        .hljs-deletion,
        .hljs-meta {
            color: #6272A4;
        }

        .hljs-keyword,
        .hljs-selector-tag,
        .hljs-literal,
        .hljs-title,
        .hljs-section,
        .hljs-doctag,
        .hljs-type,
        .hljs-name,
        .hljs-strong {
            font-weight: bold;
        }

        .hljs-emphasis {
            font-style: italic;
        }

        .hljs-number,
        span.hljs-number,
        span.hljs-literal,
        span.hljs-params {
            color: #BD93F9;
        }

        .hljs-regexp,
        .hljs-built_in {
            color: #50FA7B;
        }

        .hljs-tag {
            color: #FF79C6;
        }

        .hljs-attr {
            color: #50FA7B;
        }

        .hljs-symbol,
        .hljs-bullet {
            color: #FFB86C;
        }

        .hljs-code,
        .hljs-title,
        .hljs-section,
        span.hljs-title {
            color: #8BE9FD;
        }

        /* Ensure background color for all highlighted elements */
        #bytecode-display pre,
        #decompiled-display pre,
        #opcodes-display pre,
        #yul-display pre,
        #bytecode-display code,
        #decompiled-display code,
        #opcodes-display code,
        #yul-display code,
        .hljs,
        .language-solidity,
        .language-plaintext,
        .language-x86asm {
            background-color: #282A36 !important;
        }


        #bytecode-display,
        #decompiled-display,
        #opcodes-display,
        #yul-display,
        #bytecode-display pre,
        #decompiled-display pre,
        #opcodes-display pre,
        #yul-display pre,
        #bytecode-display code,
        #decompiled-display code,
        #opcodes-display code,
        #yul-display code {
            color: #F8F8F2;
        }

        .opcode-tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .opcode-tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .opcode-tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .scratch-space {
            background-color: rgba(255, 121, 198, 0.2);
        }

        .free-memory-pointer {
            background-color: rgba(189, 147, 249, 0.2);
        }

        .allocatable-memory {
            background-color: rgba(80, 250, 123, 0.2);
        }

        .keyword {
            color: #FF79C6;
        }

        .comment {
            color: #6272A4;
        }

        .number {
            color: #BD93F9;
        }

        .opcode-tooltip {
            color: #50FA7B;
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .opcode-tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #44475A;
            color: #F8F8F2;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .opcode-tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        #theme-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        #switch-theme {
            background-color: #44475A;
            color: #F8F8F2;
            border: 1px solid #6272A4;
            cursor: pointer;
            font-family: 'Monaspace Argon', monospace;
            padding: 5px 10px;
            transition: background-color 0.3s;
        }

        #switch-theme:hover {
            background-color: #6272A4;
        }

        /* One Dark theme */
        body.one-dark,
        .one-dark html {
            color: #ABB2BF;
            background-color: #282C34;
        }

        .one-dark .container {
            border-color: #3E4451;
        }

        .one-dark .left-panel {
            border-right-color: #3E4451;
        }

        .one-dark .search-container,
        .one-dark .tab-bar {
            background-color: #3E4451;
            border-bottom-color: #5C6370;
        }

        .one-dark #contract-address,
        .one-dark #chat-input input {
            background-color: #282C34;
            color: #ABB2BF;
            border-color: #5C6370;
        }

        .one-dark #search-btn,
        .one-dark #send-chat,
        .one-dark #switch-theme {
            background-color: #3E4451;
            color: #ABB2BF;
            border-color: #5C6370;
        }

        .one-dark #search-btn:hover,
        .one-dark #send-chat:hover,
        .one-dark #switch-theme:hover {
            background-color: #5C6370;
        }

        .one-dark .tab.active {
            background-color: #282C34;
            color: #C678DD;
        }

        .one-dark #bytecode-display,
        .one-dark #decompiled-display,
        .one-dark #opcodes-display,
        .one-dark #yul-display,
        .one-dark #instructions-display,
        .one-dark #chat-history {
            background-color: #282C34;
        }

        .one-dark #chat-input {
            background-color: #3E4451;
            border-top-color: #5C6370;
        }

        .one-dark .chat-message.user {
            background-color: #3E4451;
            border-left-color: #C678DD;
        }

        .one-dark .chat-message.assistant {
            background-color: #2C313A;
            border-left-color: #98C379;
        }

        .one-dark .chat-message.error {
            background-color: #3E4451;
            border-left-color: #E06C75;
            color: #E06C75;
        }

        .one-dark .keyword {
            color: #C678DD;
        }

        .one-dark .comment {
            color: #5C6370;
        }

        .one-dark .number {
            color: #D19A66;
        }

        .one-dark .opcode-tooltip {
            color: #98C379;
        }

        .one-dark .opcode-tooltip .tooltiptext {
            background-color: #3E4451;
            color: #ABB2BF;
        }

        .one-dark .scratch-space {
            background-color: rgba(224, 108, 117, 0.2);
        }

        .one-dark .free-memory-pointer {
            background-color: rgba(198, 120, 221, 0.2);
        }

        .one-dark .allocatable-memory {
            background-color: rgba(152, 195, 121, 0.2);
        }

        .one-dark #instructions-display {
            background-color: #282C34;
            color: #ABB2BF;
        }

        .one-dark #instructions-display h2 {
            color: #C678DD;
        }

        body.catppuccin-mocha,
        .catppuccin-mocha html {
            color: #cdd6f4;
            background-color: #1e1e2e;
        }

        .catppuccin-mocha .container {
            border-color: #313244;
        }

        .catppuccin-mocha .left-panel {
            border-right-color: #313244;
        }

        .catppuccin-mocha .search-container,
        .catppuccin-mocha .tab-bar {
            background-color: #313244;
            border-bottom-color: #45475a;
        }

        .catppuccin-mocha #contract-address,
        .catppuccin-mocha #chat-input input {
            background-color: #1e1e2e;
            color: #cdd6f4;
            border-color: #45475a;
        }

        .catppuccin-mocha #search-btn,
        .catppuccin-mocha #send-chat,
        .catppuccin-mocha #switch-theme {
            background-color: #313244;
            color: #cdd6f4;
            border-color: #45475a;
        }

        .catppuccin-mocha #search-btn:hover,
        .catppuccin-mocha #send-chat:hover,
        .catppuccin-mocha #switch-theme:hover {
            background-color: #45475a;
        }

        .catppuccin-mocha .tab.active {
            background-color: #1e1e2e;
            color: #cba6f7;
        }

        .catppuccin-mocha #bytecode-display,
        .catppuccin-mocha #decompiled-display,
        .catppuccin-mocha #opcodes-display,
        .catppuccin-mocha #yul-display,
        .catppuccin-mocha #instructions-display,
        .catppuccin-mocha #chat-history {
            background-color: #1e1e2e;
        }

        .catppuccin-mocha #chat-input {
            background-color: #313244;
            border-top-color: #45475a;
        }

        .catppuccin-mocha .chat-message.user {
            background-color: #313244;
            border-left-color: #cba6f7;
        }

        .catppuccin-mocha .chat-message.assistant {
            background-color: #45475a;
            border-left-color: #a6e3a1;
        }

        .catppuccin-mocha .chat-message.error {
            background-color: #313244;
            border-left-color: #f38ba8;
            color: #f38ba8;
        }

        .catppuccin-mocha .keyword {
            color: #cba6f7;
        }

        .catppuccin-mocha .comment {
            color: #6c7086;
        }

        .catppuccin-mocha .number {
            color: #fab387;
        }

        .catppuccin-mocha .opcode-tooltip {
            color: #a6e3a1;
        }

        .catppuccin-mocha .opcode-tooltip .tooltiptext {
            background-color: #313244;
            color: #cdd6f4;
        }

        .catppuccin-mocha .scratch-space {
            background-color: rgba(243, 139, 168, 0.2);
        }

        .catppuccin-mocha .free-memory-pointer {
            background-color: rgba(203, 166, 247, 0.2);
        }

        .catppuccin-mocha .allocatable-memory {
            background-color: rgba(166, 227, 161, 0.2);
        }

        .catppuccin-mocha #instructions-display {
            background-color: #1e1e2e;
            color: #cdd6f4;
        }

        .catppuccin-mocha #instructions-display h2 {
            color: #cba6f7;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sevm@0.6/dist/sevm.js"></script>
</head>

<body class="catppuccin-mocha">
    <div id="theme-switcher">
        <button id="switch-theme">Switch Theme</button>
    </div>
    <div class="container">
        <div class="left-panel">
            <div class="search-container">
                <input type="text" id="contract-address" placeholder="Enter Ethereum contract address or bytecode" />
                <button id="search-btn">Search</button>
            </div>
            <div class="tab-bar">
                <div class="tab active" data-tab="bytecode">Bytecode</div>
                <div class="tab" data-tab="decompiled">Decompiled</div>
                <div class="tab" data-tab="opcodes">Opcodes</div>
                <div class="tab" data-tab="yul">Yul</div>
                <div class="tab" data-tab="instructions">Instructions</div>
            </div>
            <div id="bytecode-display"></div>
            <div id="decompiled-display" style="display: none;"></div>
            <div id="opcodes-display" style="display: none;"></div>
            <div id="yul-display" style="display: none;"></div>
            <div id="instructions-display" style="display: none;">
                <h2>How to Use This Site</h2>
                <ol>
                    <li>Enter an Ethereum contract address or bytecode in the search bar and click "Search" or press Enter.</li>
                    <li>The contract's bytecode will be displayed in the "Bytecode" tab.</li>
                    <li>Click on the "Decompiled" tab to view the decompiled Solidity-like code.</li>
                    <li>The "Opcodes" tab shows the low-level EVM opcodes of the contract.</li>
                    <li>Use the chat feature on the right to ask questions about the contract's code or functionality.</li>
                </ol>
                <p>This tool helps you analyze and understand Ethereum smart contracts. If you need assistance, feel free to ask in the chat. The LLM (Hermes-2-Pro-Llama-3-8B) runs entirely in your browser using WebGPU. Please note that the LLM's output may not always be accurate, so don't treat it as definitive.</p>
                <p>For demonstration purposes only.</p>
            </div>
        </div>
        <div class="resizer-x"></div>
        <div class="right-panel">
            <div id="chat-history"></div>
            <div id="chat-input">
                <input disabled type="text" id="chat-message" placeholder="Initializing..." />
                <button disabled id="send-chat">Send</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Set this to false to disable WebLLM initialization during development
        const ENABLE_WEBLLM = true;

        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        const contractAddressInput = document.getElementById("contract-address");
        const searchButton = document.getElementById("search-btn");
        const bytecodeDisplay = document.getElementById("bytecode-display");
        const decompiledDisplay = document.getElementById("decompiled-display");
        const opcodesDisplay = document.getElementById("opcodes-display");
        const yulDisplay = document.getElementById("yul-display");
        const instructionsDisplay = document.getElementById("instructions-display");
        const chatHistory = document.getElementById("chat-history");
        const chatInput = document.getElementById("chat-message");
        const sendChatButton = document.getElementById("send-chat");
        const tabs = document.querySelectorAll(".tab");
        const themeSwitcher = document.getElementById("switch-theme");
        let currentTheme = "catppuccin-mocha";

        let bytecode = "";
        let decompiled = "";
        let opcodes = "";
        let yul = "";
        let activeTab = "bytecode";
        let selectedText = "";

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                tabs.forEach(t => t.classList.remove("active"));
                tab.classList.add("active");
                activeTab = tab.dataset.tab;
                document.getElementById("bytecode-display").style.display = "none";
                document.getElementById("decompiled-display").style.display = "none";
                document.getElementById("opcodes-display").style.display = "none";
                document.getElementById("yul-display").style.display = "none";
                document.getElementById("instructions-display").style.display = "none";
                document.getElementById(`${activeTab}-display`).style.display = "block";
                
                if (activeTab === "decompiled" && !decompiled) {
                    decompileContract(bytecode);
                } else if (activeTab === "opcodes" && !opcodes) {
                    displayOpcodes(bytecode);
                } else if (activeTab === "yul" && !yul) {
                    displayYul(bytecode);
                }
                selectedText = "";
            });
        });


        [bytecodeDisplay, decompiledDisplay, opcodesDisplay, yulDisplay, instructionsDisplay].forEach(display => {
            display.addEventListener("mouseup", () => {
                selectedText = window.getSelection().toString().trim();
            });
        });

        async function patchContract(contract) {
            const keys = Object.keys;
            const hex = selector => '0x' + selector;
            const functions = [...keys(contract.functions), ...keys(contract.reverts)].map(hex).join(',');
            const events = keys(contract.events).map(hex).join(',');

            let lookup = {};

            const url = `https://api.openchain.xyz/signature-database/v1/lookup?function=${functions}&event=${events}`;
            const resp = await fetch(url);

            if (!resp.ok) {
                throw new Error(`Failed to fetch signatures from api.openchain.xyz, url: ${url}`);
            }

            const { result } = await resp.json();

            const mapHashes = hashes => Object.fromEntries(
                Object.entries(hashes).map(([hash, matches]) => [hash, matches?.map(({ name }) => name) ?? []])
            );

            lookup.function = mapHashes(result.function);
            lookup.event = mapHashes(result.event);

            for (let [selector, fn] of Object.entries(contract.functions)) {
                selector = '0x' + selector;
                if (selector in lookup.function)
                    fn.label = lookup.function[selector][0];
            }

            for (let [topic, event] of Object.entries(contract.events)) {
                topic = '0x' + topic;
                if (topic in lookup.event)
                    event.sig = lookup.event[topic][0];
            }

            for (let [selector, decl] of Object.entries(contract.reverts)) {
                selector = '0x' + selector;
                if (selector in lookup.function)
                    decl.sig = lookup.function[selector][0];
            }

            return contract;
        }


        async function searchContract() {
            const input = contractAddressInput.value.trim();
            if (input) {
                if (input.startsWith('0x') && input.length > 42) {
                    // Input is bytecode
                    bytecode = input;
                    displayBytecode(bytecode);
                    decompiled = "";
                    opcodes = "";
                    yul = "";
                    processNewBytecode();
                } else {
                    // Input is an address
                    try {
                        const response = await fetch("https://eth.llamarpc.com", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                jsonrpc: "2.0",
                                method: "eth_getCode",
                                params: [input],
                                id: 0,
                            }),
                        });

                        const data = await response.json();
                        bytecode = data.result;
                        displayBytecode(bytecode);
                        decompiled = "";
                        opcodes = "";
                        yul = "";
                        processNewBytecode();
                    } catch (error) {
                        console.error("Error fetching bytecode:", error);
                        bytecodeDisplay.textContent = "Error fetching bytecode. Please try again.";
                    }
                }
            }
        }

        function processNewBytecode() {
            if (activeTab === "decompiled") {
                decompileContract(bytecode);
            } else if (activeTab === "opcodes") {
                displayOpcodes(bytecode);
            } else if (activeTab === "yul") {
                displayYul(bytecode);
            }
        }

        function displayBytecode(code) {
            const scratchSpaceEnd = 64 * 2; // 64 bytes * 2 characters per byte
            const freeMemoryPointerEnd = 96 * 2; // 96 bytes * 2 characters per byte
            const allocatableMemoryStart = 128 * 2; // 128 bytes * 2 characters per byte

            let formattedCode = '';
            for (let i = 0; i < code.length; i += 64) {
                const line = code.slice(i, i + 64);
                let coloredLine = '';

                for (let j = 0; j < line.length; j += 2) {
                    const bytePosition = i + j;
                    const byte = line.slice(j, j + 2);

                    if (bytePosition < scratchSpaceEnd) {
                        coloredLine += `<span class="scratch-space">${byte}</span>`;
                    } else if (bytePosition < freeMemoryPointerEnd) {
                        coloredLine += `<span class="free-memory-pointer">${byte}</span>`;
                    } else if (bytePosition >= allocatableMemoryStart) {
                        coloredLine += `<span class="allocatable-memory">${byte}</span>`;
                    } else {
                        coloredLine += byte;
                    }
                }

                formattedCode += coloredLine + '\n';
            }

            bytecodeDisplay.innerHTML = `<pre>${formattedCode}</pre>`;
        }

        const opcodeExplanations = {
            STOP: "Halts execution",
            ADD: "Addition operation",
            SUB: "Subtraction operation",
            MUL: "Multiplication operation",
            DIV: "Integer division operation",
            SDIV: "Signed integer division operation",
            MOD: "Modulo operation",
            SMOD: "Signed modulo operation",
            EXP: "Exponential operation",
            NOT: "Bitwise NOT operation",
            LT: "Less-than comparison",
            GT: "Greater-than comparison",
            SLT: "Signed less-than comparison",
            SGT: "Signed greater-than comparison",
            EQ: "Equality comparison",
            ISZERO: "Simple not operator",
            AND: "Bitwise AND operation",
            OR: "Bitwise OR operation",
            XOR: "Bitwise XOR operation",
            BYTE: "Retrieve single byte from word",
            SHL: "Bitwise left shift",
            SHR: "Bitwise right shift",
            SAR: "Bitwise right shift with sign extension",
            ADDMOD: "Addition modulo operation",
            MULMOD: "Multiplication modulo operation",
            SIGNEXTEND: "Extend length of two's complement signed integer",
            KECCAK256: "Compute Keccak-256 hash",
            PC: "Get the value of the program counter",
            POP: "Remove item from stack",
            MLOAD: "Load word from memory",
            MSTORE: "Save word to memory",
            MSTORE8: "Save byte to memory",
            SLOAD: "Load word from storage",
            SSTORE: "Save word to storage",
            MSIZE: "Get the size of the memory in bytes",
            GAS: "Get the amount of available gas",
            ADDRESS: "Get address of currently executing account",
            BALANCE: "Get balance of the given account",
            SELFBALANCE: "Get balance of the currently executing account",
            CALLER: "Get caller address",
            CALLVALUE: "Get deposited value by the instruction/transaction responsible for this execution",
            CALLDATALOAD: "Get input data of current environment",
            CALLDATASIZE: "Get size of input data in current environment",
            CALLDATACOPY: "Copy input data in current environment to memory",
            CODESIZE: "Get size of code running in current environment",
            CODECOPY: "Copy code running in current environment to memory",
            EXTCODESIZE: "Get size of an account's code",
            EXTCODECOPY: "Copy an account's code to memory",
            RETURNDATASIZE: "Get size of output data from the previous call from the current environment",
            RETURNDATACOPY: "Copy output data from the previous call from the current environment to memory",
            EXTCODEHASH: "Get hash of an account's code",
            CREATE: "Create a new account with associated code",
            CREATE2: "Create a new account with associated code using salt",
            CALL: "Message-call into an account",
            CALLCODE: "Message-call into this account with alternative account's code",
            DELEGATECALL: "Message-call into this account with an alternative account's code, but persisting the current values for sender and value",
            STATICCALL: "Static message-call into an account",
            RETURN: "Halt execution returning output data",
            REVERT: "Halt execution reverting state changes but returning data and remaining gas",
            SELFDESTRUCT: "Halt execution and register account for deletion",
            INVALID: "Designated invalid instruction",
            LOG0: "Append log record with no topics",
            LOG1: "Append log record with one topic",
            LOG2: "Append log record with two topics",
            LOG3: "Append log record with three topics",
            LOG4: "Append log record with four topics",
            CHAINID: "Get the chain ID",
            ORIGIN: "Get execution origination address",
            GASPRICE: "Get price of gas in current environment",
            BLOCKHASH: "Get the hash of one of the 256 most recent complete blocks",
            COINBASE: "Get the block's beneficiary address",
            TIMESTAMP: "Get the block's timestamp",
            NUMBER: "Get the block's number",
            DIFFICULTY: "Get the block's difficulty",
            GASLIMIT: "Get the block's gas limit",
            PUSH1: "Push 1 byte onto the stack",
            PUSH2: "Push 2 bytes onto the stack",
            PUSH3: "Push 3 bytes onto the stack",
            PUSH4: "Push 4 bytes onto the stack",
            PUSH5: "Push 5 bytes onto the stack",
            PUSH6: "Push 6 bytes onto the stack",
            PUSH7: "Push 7 bytes onto the stack",
            PUSH8: "Push 8 bytes onto the stack",
            PUSH9: "Push 9 bytes onto the stack",
            PUSH10: "Push 10 bytes onto the stack",
            PUSH11: "Push 11 bytes onto the stack",
            PUSH12: "Push 12 bytes onto the stack",
            PUSH13: "Push 13 bytes onto the stack",
            PUSH14: "Push 14 bytes onto the stack",
            PUSH15: "Push 15 bytes onto the stack",
            PUSH16: "Push 16 bytes onto the stack",
            PUSH17: "Push 17 bytes onto the stack",
            PUSH18: "Push 18 bytes onto the stack",
            PUSH19: "Push 19 bytes onto the stack",
            PUSH20: "Push 20 bytes onto the stack",
            PUSH21: "Push 21 bytes onto the stack",
            PUSH22: "Push 22 bytes onto the stack",
            PUSH23: "Push 23 bytes onto the stack",
            PUSH24: "Push 24 bytes onto the stack",
            PUSH25: "Push 25 bytes onto the stack",
            PUSH26: "Push 26 bytes onto the stack",
            PUSH27: "Push 27 bytes onto the stack",
            PUSH28: "Push 28 bytes onto the stack",
            PUSH29: "Push 29 bytes onto the stack",
            PUSH30: "Push 30 bytes onto the stack",
            PUSH31: "Push 31 bytes onto the stack",
            PUSH32: "Push 32 bytes onto the stack",
            DUP1: "Duplicate 1st stack item",
            DUP2: "Duplicate 2nd stack item",
            DUP3: "Duplicate 3rd stack item",
            DUP4: "Duplicate 4th stack item",
            DUP5: "Duplicate 5th stack item",
            DUP6: "Duplicate 6th stack item",
            DUP7: "Duplicate 7th stack item",
            DUP8: "Duplicate 8th stack item",
            DUP9: "Duplicate 9th stack item",
            DUP10: "Duplicate 10th stack item",
            DUP11: "Duplicate 11th stack item",
            DUP12: "Duplicate 12th stack item",
            DUP13: "Duplicate 13th stack item",
            DUP14: "Duplicate 14th stack item",
            DUP15: "Duplicate 15th stack item",
            DUP16: "Duplicate 16th stack item",
            SWAP1: "Exchange 1st and 2nd stack items",
            SWAP2: "Exchange 1st and 3rd stack items",
            SWAP3: "Exchange 1st and 4th stack items",
            SWAP4: "Exchange 1st and 5th stack items",
            SWAP5: "Exchange 1st and 6th stack items",
            SWAP6: "Exchange 1st and 7th stack items",
            SWAP7: "Exchange 1st and 8th stack items",
            SWAP8: "Exchange 1st and 9th stack items",
            SWAP9: "Exchange 1st and 10th stack items",
            SWAP10: "Exchange 1st and 11th stack items",
            SWAP11: "Exchange 1st and 12th stack items",
            SWAP12: "Exchange 1st and 13th stack items",
            SWAP13: "Exchange 1st and 14th stack items",
            SWAP14: "Exchange 1st and 15th stack items",
            SWAP15: "Exchange 1st and 16th stack items",
            SWAP16: "Exchange 1st and 17th stack items"
        };


        function highlightSolidity(code) {
            const keywords = ['function', 'contract', 'address', 'uint', 'int', 'bool', 'string', 'mapping', 'struct', 'enum', 'public', 'private', 'internal', 'external', 'view', 'pure', 'payable', 'return', 'if', 'else', 'for', 'while', 'do', 'break', 'continue', 'new', 'delete', 'memory', 'storage'];
            const keywordRegex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'g');

            return code.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(keywordRegex, '<span class="keyword">$1</span>')
                .replace(/(\/\/.*)/g, '<span class="comment">$1</span>')
                .replace(/(0x[a-fA-F0-9]+)/g, '<span class="number">$1</span>');
        }

        function highlightOpcodes(code) {
            const opcodes = [
                'STOP', 'ADD', 'SUB', 'MUL', 'DIV', 'SDIV', 'MOD', 'SMOD', 'EXP', 'NOT',
                'LT', 'GT', 'SLT', 'SGT', 'EQ', 'ISZERO', 'AND', 'OR', 'XOR', 'BYTE',
                'SHL', 'SHR', 'SAR', 'ADDMOD', 'MULMOD', 'SIGNEXTEND', 'KECCAK256',
                'PC', 'POP', 'MLOAD', 'MSTORE', 'MSTORE8', 'SLOAD', 'SSTORE', 'MSIZE',
                'GAS', 'ADDRESS', 'BALANCE', 'SELFBALANCE', 'CALLER', 'CALLVALUE',
                'CALLDATALOAD', 'CALLDATASIZE', 'CALLDATACOPY', 'CODESIZE', 'CODECOPY',
                'EXTCODESIZE', 'EXTCODECOPY', 'RETURNDATASIZE', 'RETURNDATACOPY',
                'EXTCODEHASH', 'CREATE', 'CREATE2', 'CALL', 'CALLCODE', 'DELEGATECALL',
                'STATICCALL', 'RETURN', 'REVERT', 'SELFDESTRUCT', 'INVALID', 'LOG0',
                'LOG1', 'LOG2', 'LOG3', 'LOG4', 'CHAINID', 'ORIGIN', 'GASPRICE',
                'BLOCKHASH', 'COINBASE', 'TIMESTAMP', 'NUMBER', 'DIFFICULTY', 'GASLIMIT',
                'PUSH1', 'PUSH2', 'PUSH3', 'PUSH4', 'PUSH5', 'PUSH6', 'PUSH7', 'PUSH8',
                'PUSH9', 'PUSH10', 'PUSH11', 'PUSH12', 'PUSH13', 'PUSH14', 'PUSH15', 'PUSH16',
                'PUSH17', 'PUSH18', 'PUSH19', 'PUSH20', 'PUSH21', 'PUSH22', 'PUSH23', 'PUSH24',
                'PUSH25', 'PUSH26', 'PUSH27', 'PUSH28', 'PUSH29', 'PUSH30', 'PUSH31', 'PUSH32',
                'DUP1', 'DUP2', 'DUP3', 'DUP4', 'DUP5', 'DUP6', 'DUP7', 'DUP8',
                'DUP9', 'DUP10', 'DUP11', 'DUP12', 'DUP13', 'DUP14', 'DUP15', 'DUP16',
                'SWAP1', 'SWAP2', 'SWAP3', 'SWAP4', 'SWAP5', 'SWAP6', 'SWAP7', 'SWAP8',
                'SWAP9', 'SWAP10', 'SWAP11', 'SWAP12', 'SWAP13', 'SWAP14', 'SWAP15', 'SWAP16'
            ];

            const opcodeRegex = new RegExp(`\\b(${opcodes.join('|')})\\b`, 'g');
            return code.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(opcodeRegex, (match) => {
                    const explanation = opcodeExplanations[match] || "No explanation available";
                    return `<span class="opcode-tooltip">${match}<span class="tooltiptext">${explanation}</span></span>`;
                });
        }

        async function decompileContract(bytecode) {
            try {
                const contract = new sevm.Contract(bytecode);
                await patchContract(contract);
                decompiled = contract.solidify();
                const highlightedDecompiled = highlightSolidity(decompiled);
                decompiledDisplay.innerHTML = `<pre>${highlightedDecompiled}</pre>`;
            } catch (error) {
                console.error("Error decompiling contract:", error);
                decompiledDisplay.textContent = "Error decompiling contract. Please try again.";
            }
        }

        function displayOpcodes(bytecode) {
            try {
                const contract = new sevm.Contract(bytecode);
                opcodes = contract.opcodes();
                const opcodesText = opcodes.map(opcode => opcode.format()).join('\n');
                const highlightedOpcodes = highlightOpcodes(opcodesText);
                opcodesDisplay.innerHTML = `<pre>${highlightedOpcodes}</pre>`;
            } catch (error) {
                console.error("Error displaying opcodes:", error);
                opcodesDisplay.textContent = "Error displaying opcodes. Please try again.";
            }
        }

        async function displayYul(bytecode) {
            try {
                const contract = new sevm.Contract(bytecode);
                await patchContract(contract);
                yul = contract.yul();
                const highlightedYul = highlightYul(yul);
                yulDisplay.innerHTML = `<pre>${highlightedYul}</pre>`;
            } catch (error) {
                console.error("Error displaying Yul:", error);
                yulDisplay.textContent = "Error displaying Yul. Please try again.";
            }
        }

        function highlightYul(code) {
            const keywords = ['function', 'let', 'if', 'switch', 'case', 'default', 'for', 'break', 'continue', 'leave'];
            const keywordRegex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'g');

            return code.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(keywordRegex, '<span class="keyword">$1</span>')
                .replace(/(\/\/.*)/g, '<span class="comment">$1</span>')
                .replace(/(0x[a-fA-F0-9]+)/g, '<span class="number">$1</span>');
        }

        searchButton.addEventListener("click", searchContract);
        contractAddressInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                searchContract();
            }
        });

        // Conditional WebLLM initialization
        let engine;
        if (ENABLE_WEBLLM) {
            const initProgressCallback = (progress) => {
                if (progress.progress < 1) {
                    sendChatButton.disabled = true;
                    chatInput.disabled = true;
                    chatInput.placeholder = progress.text;
                } else {
                    sendChatButton.disabled = false;
                    chatInput.disabled = false;
                    chatInput.placeholder = "Ask about the bytecode, decompiled functions, or opcodes...";
                }
            };

            const selectedModel = "DeepSeek-R1-Distill-Qwen-7B-q4f16_1-MLC";
            const appConfig = webllm.prebuiltAppConfig;
            appConfig.useIndexedDBCache = true;
            engine = new webllm.MLCEngine({
                initProgressCallback,
                appConfig,
            });
            engine.reload(selectedModel);
        } else {
            // Disable chat functionality when WebLLM is not initialized
            sendChatButton.disabled = true;
            chatInput.disabled = true;
            chatInput.placeholder = "WebLLM is disabled for development";
        }

        let history = "";

        sendChatButton.addEventListener("click", async () => {
            const message = chatInput.value;
            if (message.trim()) {
                let systemContent = `You are an expert in EVM bytecode, reverse engineering Solidity contracts, and interpreting opcodes. A user is reading decompiled EVM bytecode, EVM bytecode, disassembled opcodes, and Yul. You have deep knowledge of `;

                switch (activeTab) {
                    case 'bytecode':
                        systemContent += `EVM bytecode:
- Bytecode is a sequence of opcodes and data
- Opcodes: 00 (STOP), f3 (RETURN), 52 (MSTORE), 39 (CODECOPY)
- Function selectors are first 4 bytes of keccak256 hash of function signature
- Common patterns: PUSH1 0x80 (free memory pointer), PUSH1 0x40 (allocate memory)
- Bytecode structure: constructor code, runtime code, metadata
- Optimization techniques: code reuse, bitwise operations
- Stack: PUSH1-PUSH32 (60-7f) push 1-32 bytes onto stack
- Memory: First 64 bytes (0x00-0x3f) reserved for scratch space
- Free memory pointer typically starts at 0x80
- Deployment: Constructor returns runtime code using RETURN (f3)
- Data encoding: 
  - Strings: [32-byte offset][32-byte length][data]
  - Function selectors: First 4 bytes of keccak256(function signature)
- Common patterns:
  - PUSH1 0x80 PUSH1 0x40 MSTORE (set free memory pointer)
  - PUSH1 [length] PUSH1 [offset] RETURN (return data)
- Analyze with: ethervm.io, evm-opcodes (GitHub), seth tool
- Optimization: Reuse code, use bitwise ops, minimize storage`;


                        break;
                    case 'opcodes':
                        systemContent += `EVM bytecode:
- One-byte instructions (0x00-0xff), except PUSH1-PUSH32 (0x60-0x7f)
- Stack: 1024 item limit, 256-bit words, LIFO structure
- Memory: Byte-addressable, expandable
- Storage: 256-bit addresses to 256-bit words, persistent
- Key opcode categories:
  - Arithmetic/Logic: ADD (0x01), MUL (0x02), AND (0x16), etc.
  - Memory/Storage: MLOAD (0x51), MSTORE (0x52), SLOAD (0x54), SSTORE (0x55)
  - Control flow: JUMP (0x56), JUMPI (0x57), JUMPDEST (0x5b)
  - Environment: ADDRESS (0x30), BALANCE (0x31), CALLVALUE (0x34)
- PUSH operations (0x60-0x7f): Push 1-32 bytes onto stack
- Execution model: 
  - Stack items pushed in reverse order of use
  - Example: MSTORE expects [offset, value] on stack
- Gas costs vary: SSTORE (20000*), ADD (3), BALANCE (700)
- Optimization: Use bitwise ops, minimize storage ops, reuse memory
- Error cases: Insufficient gas, stack overflow/underflow`;

                        break;
                    case 'yul':
                        systemContent += `Yul intermediate language:
- Low-level language for the EVM
- Used for inline assembly in Solidity and as an intermediate language for optimization
- Key constructs: functions, variables, if/switch statements, for loops
- Built-in functions correspond to EVM opcodes
- Typed language with only one type (256-bit words) in EVM dialect
-Built-in Functions:datasize("id"), dataoffset("id"), datacopy(t, f, l) keccak256(p, n), create(v, p, n), create2(v, p, n, s)
- Syntax closer to high-level languages than raw bytecode
- Used for writing more gas-efficient code and accessing EVM features not available in Solidity
- Important for writing custom low-level operations and optimizations
Memory Management: Free memory pointer typically at 0x40
Allocate memory: let ptr := mload(0x40); mstore(0x40, add(ptr, size))`;
                        break;
                    case 'decompiled':
                        systemContent += `Solidity and decompiled contracts:
- High-level, contract-oriented language for Ethereum
- Key features: contract inheritance, libraries, user-defined types
- Common patterns: SafeMath operations, access control (e.g., Ownable)
- Data types: uint/int (various sizes), address, bool, bytes, string, arrays, mappings
- Function visibility: public, private, internal, external
- Modifiers for function behavior modification
- Events for logging and front-end interaction
- Gas optimization techniques: appropriate data types, storage vs. memory usage
- Security considerations: reentrancy, overflow/underflow, proper access control
- Decompiled code may lack original variable names and comments`;
                        break;
                }

                systemContent += `

You are provided with a question from a user related to the current view (${activeTab}). Answer the user's request accurately and concisely, leveraging your knowledge of the EVM and the specific context. Your output must be both precise and concise. The content of the code the user is looking at is provided to help you answer them in context.`;

                const MAX_CONTEXT_LENGTH = 11000;
                const BUFFER_FOR_USER_MESSAGE = 1000; // Reserve space for user message

                // Calculate available space for context
                const systemPromptLength = systemContent.length;
                const availableSpace = MAX_CONTEXT_LENGTH - systemPromptLength - BUFFER_FOR_USER_MESSAGE;

                let contextContent = selectedText;
                if (!contextContent) {
                    const activeDisplay = document.getElementById(`${activeTab}-display`);
                    contextContent = activeDisplay.textContent.slice(0, availableSpace);
                }

                systemContent += `This is the ${activeTab} content: \`\`\`${contextContent}\`\`\``;

                const messages = [
                    {
                        role: "system",
                        content: systemContent,
                    },
                    { role: "user", content: message },
                ];

                let userMessageDiv = document.createElement("div");
                userMessageDiv.classList.add("chat-message", "user");
                userMessageDiv.innerHTML = new showdown.Converter().makeHtml(message);
                chatHistory.appendChild(userMessageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                chatInput.value = "";
                chatInput.placeholder = "Generating...";

                try {
                    const chunks = await engine.chat.completions.create({
                        messages,
                        temperature: 1,
                        stream: true,
                        stream_options: { include_usage: true },
                    });
                    let botMessageDiv = document.createElement("div");
                    botMessageDiv.classList.add("chat-message", "assistant");
                    chatHistory.appendChild(botMessageDiv);
                    let output = "";
                    for await (const chunk of chunks) {
                        console.log(chunk);
                        output += chunk.choices[0]?.delta.content ?? "";
                        botMessageDiv.innerHTML = new showdown.Converter().makeHtml(output);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    }
                    history += output + "\n";
                } catch (error) {
                    console.error("Error in chat completion:", error);
                    let errorDiv = document.createElement("div");
                    errorDiv.classList.add("chat-message", "error");
                    errorDiv.textContent = "An error occurred while generating the response. Please try again.";
                    chatHistory.appendChild(errorDiv);
                } finally {
                    chatInput.placeholder = "Ask about the bytecode, decompiled functions, or opcodes...";
                }
            }
        });

        chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendChatButton.click();
            }
        });


        themeSwitcher.addEventListener("click", () => {
            switch (currentTheme) {
                case "catppuccin-mocha":
                    document.body.classList.remove("catppuccin-mocha");
                    document.body.classList.add("dracula");
                    currentTheme = "dracula";
                    break;
                case "dracula":
                    document.body.classList.remove("dracula");
                    document.body.classList.add("one-dark");
                    currentTheme = "one-dark";
                    break;
                case "one-dark":
                    document.body.classList.remove("one-dark");
                    document.body.classList.add("catppuccin-mocha");
                    currentTheme = "catppuccin-mocha";
                    break;
            }
        });
    </script>
</body>

</html>